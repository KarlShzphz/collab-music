<!DOCTYPE html>
<html>
<head>
    <title>–¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ MP3</title>
</head>
<body>
    <h1>–¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ MP3 –Ω–∞ —Å–µ—Ä–≤–µ—Ä</h1>
    <button id="recordBtn">–ó–∞–ø–∏—Å–∞—Ç—å 3 —Å–µ–∫—É–Ω–¥—ã</button>
    <button id="uploadBtn" disabled>–ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä</button>
    <div id="status"></div>
    <audio id="audio" controls></audio>
    
    <script>
        let mediaRecorder;
        let chunks = [];
        let recordedBlob = null;
        
        document.getElementById('recordBtn').onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
                
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) chunks.push(e.data);
                };
                
                mediaRecorder.onstop = () => {
                    const webmBlob = new Blob(chunks, { type: 'audio/webm' });
                    
                    // –°–æ–∑–¥–∞–µ–º MP3-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π blob —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º MIME —Ç–∏–ø–æ–º
                    const mp3Blob = new Blob([webmBlob], { type: 'audio/mpeg' });
                    
                    console.log('üéµ –°–æ–∑–¥–∞–Ω MP3 blob:', {
                        originalSize: webmBlob.size,
                        mp3Size: mp3Blob.size,
                        originalType: webmBlob.type,
                        mp3Type: mp3Blob.type
                    });
                    
                    recordedBlob = mp3Blob;
                    document.getElementById('audio').src = URL.createObjectURL(mp3Blob);
                    document.getElementById('uploadBtn').disabled = false;
                    document.getElementById('status').innerHTML = `–ó–∞–ø–∏—Å–∞–Ω–æ! –†–∞–∑–º–µ—Ä: ${mp3Blob.size} –±–∞–π—Ç, –¢–∏–ø: ${mp3Blob.type}`;
                };
                
                mediaRecorder.start();
                document.getElementById('status').innerHTML = '–ó–∞–ø–∏—Å—ã–≤–∞–µ–º...';
                
                setTimeout(() => {
                    mediaRecorder.stop();
                    stream.getTracks().forEach(track => track.stop());
                }, 3000);
                
            } catch (error) {
                document.getElementById('status').innerHTML = `–û—à–∏–±–∫–∞: ${error.message}`;
            }
        };
        
        document.getElementById('uploadBtn').onclick = async () => {
            if (!recordedBlob) return;
            
            try {
                const formData = new FormData();
                formData.append('audio', recordedBlob, 'test-recording.mp3');
                formData.append('title', '–¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–ø–∏—Å—å');
                formData.append('description', '–¢–µ—Å—Ç MP3 –∑–∞–≥—Ä—É–∑–∫–∏');
                formData.append('author', '–¢–µ—Å—Ç–µ—Ä');
                formData.append('bpm', '120');
                
                console.log('üåê –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä:', {
                    blobType: recordedBlob.type,
                    blobSize: recordedBlob.size,
                    filename: 'test-recording.mp3'
                });
                
                const response = await fetch('http://localhost:3001/api/recordings', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('üéµ –ó–∞–ø–∏—Å—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:', result);
                
                document.getElementById('status').innerHTML += '<br>‚úÖ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä!';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                document.getElementById('status').innerHTML += `<br>‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
            }
        };
    </script>
</body>
</html>
