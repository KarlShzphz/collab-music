<!DOCTYPE html>
<html>
<head>
    <title>–¢–µ—Å—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ñ–æ—Ä–º–∞—Ç–æ–≤</title>
</head>
<body>
    <h1>–¢–µ—Å—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ñ–æ—Ä–º–∞—Ç–æ–≤ –∑–∞–ø–∏—Å–∏</h1>
    <div id="results"></div>
    <button id="testBtn">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç—ã</button>
    <button id="recordBtn" disabled>–ó–∞–ø–∏—Å–∞—Ç—å –≤ –ª—É—á—à–µ–º —Ñ–æ—Ä–º–∞—Ç–µ</button>
    <div id="status"></div>
    <audio id="audio" controls></audio>
    
    <script>
        let bestFormat = null;
        
        document.getElementById('testBtn').onclick = () => {
            const formats = [
                'audio/mp4',
                'audio/webm;codecs=opus',
                'audio/webm',
                'audio/wav',
                'audio/ogg;codecs=opus',
                'audio/ogg'
            ];
            
            const results = document.getElementById('results');
            results.innerHTML = '<h2>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:</h2>';
            
            formats.forEach(format => {
                const supported = MediaRecorder.isTypeSupported(format);
                const color = supported ? 'green' : 'red';
                const status = supported ? '‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è' : '‚ùå –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
                
                results.innerHTML += `<div style="color: ${color}">${format}: ${status}</div>`;
                
                if (supported && !bestFormat) {
                    bestFormat = format;
                }
            });
            
            if (bestFormat) {
                results.innerHTML += `<h3>üéµ –õ—É—á—à–∏–π —Ñ–æ—Ä–º–∞—Ç: ${bestFormat}</h3>`;
                document.getElementById('recordBtn').disabled = false;
            } else {
                results.innerHTML += '<h3>‚ùå –ù–∏ –æ–¥–∏–Ω —Ñ–æ—Ä–º–∞—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è</h3>';
            }
        };
        
        document.getElementById('recordBtn').onclick = async () => {
            if (!bestFormat) return;
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const mediaRecorder = new MediaRecorder(stream, { 
                    mimeType: bestFormat,
                    audioBitsPerSecond: 128000
                });
                
                const chunks = [];
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) chunks.push(e.data);
                };
                
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: bestFormat });
                    
                    // –°–æ–∑–¥–∞–µ–º MP3-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π blob
                    const mp3Blob = new Blob([blob], { type: 'audio/mpeg' });
                    
                    document.getElementById('audio').src = URL.createObjectURL(mp3Blob);
                    document.getElementById('status').innerHTML = `
                        <strong>–ó–∞–ø–∏—Å–∞–Ω–æ!</strong><br>
                        –§–æ—Ä–º–∞—Ç: ${bestFormat}<br>
                        –†–∞–∑–º–µ—Ä: ${blob.size} –±–∞–π—Ç<br>
                        MP3 —Ä–∞–∑–º–µ—Ä: ${mp3Blob.size} –±–∞–π—Ç<br>
                        MP3 —Ç–∏–ø: ${mp3Blob.type}
                    `;
                    
                    // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                    const url = URL.createObjectURL(mp3Blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'test-recording.mp3';
                    link.textContent = '–°–∫–∞—á–∞—Ç—å MP3';
                    link.style.display = 'block';
                    link.style.marginTop = '10px';
                    document.getElementById('status').appendChild(link);
                };
                
                mediaRecorder.start();
                document.getElementById('status').innerHTML = '–ó–∞–ø–∏—Å—ã–≤–∞–µ–º 3 —Å–µ–∫—É–Ω–¥—ã...';
                
                setTimeout(() => {
                    mediaRecorder.stop();
                    stream.getTracks().forEach(track => track.stop());
                }, 3000);
                
            } catch (error) {
                document.getElementById('status').innerHTML = `–û—à–∏–±–∫–∞: ${error.message}`;
            }
        };
    </script>
</body>
</html>
